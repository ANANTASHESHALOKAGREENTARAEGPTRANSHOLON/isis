= Flyway (Extension)
:Notice: Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at. http://www.apache.org/licenses/LICENSE-2.0 . Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR  CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.


This module provides an very thin layer to use Spring Boot's integration with https://flywaydb.org[Flyway]

== Configuration

Add the following dependency:

[source,xml]
----
<dependency>
    <groupId>org.apache.isis.extensions</groupId>
    <artifactId>isis-extensions-flyway-impl</artifactId>
</dependency>
----

Also add the following module to your `AppManifest`:

[source,java]
----
@Configuration
@Import({
        // ...
        IsisModuleExtFlywayImpl.class,
        // ...
})
public static class AppManifest {
}
----

This will enable Spring Boot's integration with Flyway, and configure Flyway to pick up JDBC connection parameters from the `application.properties` (corresponding to `IsisConfiguration` class).

* `isis.persistence.jdo-datanucleus.impl.javax.jdo.option.ConnectionURL`
* `isis.persistence.jdo-datanucleus.impl.javax.jdo.option.ConnectionDriverName`
* `isis.persistence.jdo-datanucleus.impl.javax.jdo.option.ConnectionUserName`
* `isis.persistence.jdo-datanucleus.impl.javax.jdo.option.ConnectionPassword`

Currently, only the form of persistence properties recognised are those of the JDO DataNucleus object store:

For backward compatibility with v1, Flyway will be automatically disabled if JDO's `autoCreateAll` option is set:

* `isis.persistor.datanucleus.impl.datanucleus.schema.autoCreateAll`

** If `true`, then flyway is disabled
** If `false`, then flyway is enabled

Flyway can also be explicitly disabled using the Spring Boot config property:

* `spring.flyway.enabled`

** If `false`, then flyway is disabled
** If `true`, the flyway is enabled (provided also that `autoCreateAll` is set to `false`, see above)


== Automatic schema setup

TODO...

== Reference

See :

* https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto-execute-flyway-database-migrations-on-startup[Spring Boot docs] for Flyway integration
* https://www.baeldung.com/spring-boot-configure-data-source-programmatic[www.baeldung.com] docs on how to programmatically build a `DataSource`
